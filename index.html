<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BATTLELICA: PC OPTIMIZED</title>
    <style>
        /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: #111; /* PC ë°°ê²½ìƒ‰ (ì–´ë‘ìš´ íšŒìƒ‰) */
            color: #e0e0e0; 
            font-family: 'Courier New', monospace; margin: 0; 
            height: 100vh; height: 100dvh; 
            overflow: hidden; user-select: none; 
            /* PC í™”ë©´ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ Flex ì„¤ì • */
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        
        /* ì•± í”„ë ˆì„: ëª¨ë°”ì¼ í™”ë©´ ë¹„ìœ¨ì„ ìœ ì§€í•˜ëŠ” ì»¨í…Œì´ë„ˆ */
        #app-frame {
            width: 100%;
            height: 100%;
            background-color: #050505; /* ê²Œì„ ë‚´ë¶€ ë°°ê²½ìƒ‰ */
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); /* ê·¸ë¦¼ì íš¨ê³¼ */
        }

        /* --- PC í™”ë©´ ëŒ€ì‘ (ë¯¸ë””ì–´ ì¿¼ë¦¬) --- */
        @media (min-width: 768px) {
            #app-frame {
                height: 100vh; /* ë†’ì´ëŠ” í™”ë©´ ê°€ë“ */
                width: auto;   /* ë„ˆë¹„ëŠ” ë¹„ìœ¨ì— ë§ì¶¤ */
                aspect-ratio: 9/16; /* 9:16 ì„¸ë¡œ ë¹„ìœ¨ ê³ ì • */
                min-width: 360px; /* ìµœì†Œ ë„ˆë¹„ ë³´ì¥ */
                border-left: 2px solid #333;
                border-right: 2px solid #333;
            }
            
            /* PCì—ì„œëŠ” í°íŠ¸ì™€ ìš”ì†Œë¥¼ ì¡°ê¸ˆ ë” í‚¤ì›Œì„œ ê°€ë…ì„± í™•ë³´ */
            .card { width: 80px; height: 110px; font-size: 0.75em; }
            .field-card { width: 60px; height: 80px; }
            .hand-zone { height: 120px; }
            .dice-display { min-width: 130px; font-size: 1.1em; }
            button { font-size: 1.1em; padding: 10px 20px; }
        }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* --- ì‹œì‘ í™”ë©´ --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; transition: opacity 0.5s;
        }
        .title-logo { 
            font-size: 3em; font-weight: bold; color: #ff0055; 
            text-shadow: 0 0 20px #ff0055, 2px 2px 0px #00ffcc; 
            margin-bottom: 30px; letter-spacing: 5px; font-style: italic; text-align: center;
        }
        
        .mode-select { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .mode-btn {
            padding: 12px 20px; font-size: 1em; border: 2px solid #555; 
            background: #222; color: #aaa; cursor: pointer; transition: 0.3s; width: 140px; text-align: center;
        }
        .mode-btn.selected { border-color: #00ffcc; color: #00ffcc; background: #111; box-shadow: 0 0 15px rgba(0,255,204,0.3); }
        
        .deck-setup { 
            display: flex; gap: 20px; margin-bottom: 30px; opacity: 0; 
            transition: 0.5s; pointer-events: none; flex-wrap: wrap; justify-content: center; 
        }
        .deck-setup.visible { opacity: 1; pointer-events: auto; }
        
        .player-select { 
            text-align: center; border: 1px solid #333; padding: 15px; 
            border-radius: 10px; background: #111; width: 160px; 
        }
        .player-select h3 { color: #fff; border-bottom: 1px solid #555; padding-bottom: 5px; margin-top: 0; font-size: 1em;}
        select { background: #222; color: #fff; padding: 5px; border: 1px solid #00ffcc; font-size: 0.9em; width: 100%; }
        
        .start-btn-group { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 300px; }
        
        #btn-start-game {
            font-size: 1.2em; padding: 15px; background: #ff0055; color: #fff; border: none; cursor: pointer;
            box-shadow: 0 0 20px #ff0055; transition: 0.3s; opacity: 0; pointer-events: none; width: 100%;
        }
        #btn-start-game.visible { opacity: 1; pointer-events: auto; }
        
        .secondary-btn {
            font-size: 1em; padding: 12px; background: #222; color: #00ffcc; border: 1px solid #00ffcc; cursor: pointer; width: 100%;
            transition: 0.3s;
        }
        .secondary-btn:hover { background: #00ffcc; color: #000; }

        /* --- [NEW] ì¹´ë“œ ë„ê° í™”ë©´ --- */
        #collection-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0a; z-index: 5000; flex-direction: column;
        }
        .collection-header {
            padding: 15px; background: #111; border-bottom: 2px solid #00ffcc;
            display: flex; justify-content: space-between; align-items: center;
        }
        .collection-body {
            flex: 1; overflow-y: auto; padding: 20px; 
        }
        .deck-section { margin-bottom: 40px; }
        .deck-title { color: #fff; border-left: 5px solid #ff0055; padding-left: 15px; margin-bottom: 20px; font-size: 1.5em; }
        .card-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; justify-items: center;
        }
        /* ë„ê°ì—ì„œëŠ” ì¹´ë“œë¥¼ ì¢€ ë” í¬ê²Œ ë³´ì—¬ì¤Œ */
        .collection-card-wrapper { transform: scale(1.2); margin: 10px; }

        /* --- ë£°ë¶ í™”ë©´ --- */
        #rule-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0a; z-index: 5000; flex-direction: column;
        }
        .rule-header {
            padding: 15px; background: #111; border-bottom: 2px solid #ff0055;
            display: flex; justify-content: space-between; align-items: center;
        }
        .rule-body { flex: 1; overflow-y: auto; padding: 20px; font-size: 0.9em; color: #ccc; line-height: 1.6; }
        .rule-section { margin-bottom: 30px; border-bottom: 1px dashed #333; padding-bottom: 20px; }
        .rule-section h3 { color: #00ffcc; margin-top: 0; border-left: 4px solid #00ffcc; padding-left: 10px; }
        .rule-section h4 { color: #ffeb3b; margin: 15px 0 5px 0; }
        .rule-section ul { padding-left: 20px; margin: 5px 0; }
        .tuner-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        .tuner-table th, .tuner-table td { border: 1px solid #444; padding: 8px; text-align: center; }
        .tuner-table th { background: #222; color: #00ffcc; }
        .d6-col { color: #ff5555; } .d10-col { color: #55aaff; } .d20-col { color: #ffee00; }
        .highlight { color: #fff; font-weight: bold; }
        .close-btn { background: #333; color: #fff; border: 1px solid #fff; padding: 5px 15px; cursor: pointer; }
        .close-rule-btn { background: #ff0055; color: #fff; border: none; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }

        /* --- ì˜¤ë²„ë ˆì´ (ë£°ë ›, ê²Œì„ì˜¤ë²„) --- */
        #roulette-overlay, #gameover-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .roulette-box { font-size: 2em; font-weight: bold; padding: 20px; border: 4px solid #fff; color: #fff; background: #000; min-width: 250px; text-align: center; }
        .winner-text { font-size: 2.5em; font-weight: bold; color: #ffeb3b; text-shadow: 0 0 30px #ffeb3b; margin-bottom: 20px; text-align: center; }
        #btn-restart { font-size: 1.2em; padding: 15px 40px; background: #fff; color: #000; border: none; cursor: pointer; }

        /* --- ê²Œì„ í™”ë©´ --- */
        #game-container { display: none; width: 100%; height: 100%; flex-direction: column; position: relative; }
        .player-area { flex: 1; padding: 5px; display: flex; flex-direction: column; border-bottom: 1px solid #333; position: relative; z-index: 10; justify-content: space-between; }
        .active-turn { background-color: #1a1a1a; box-shadow: inset 0 0 30px rgba(0, 255, 204, 0.05); }
        .inactive-turn { background-color: #000; opacity: 0.5; pointer-events: none; filter: grayscale(80%); }
        #center-area { height: 15vh; max-height: 100px; background: #080808; border-top: 1px solid #333; border-bottom: 1px solid #333; display: flex; z-index: 20; }
        #game-log { flex: 1; overflow-y: auto; padding: 5px; font-size: 0.7em; color: #aaa; border-right: 1px solid #333; line-height: 1.3; }
        #tuner-guide { width: 120px; padding: 5px; font-size: 0.6em; color: #888; background: #0e0e0e; display: flex; flex-direction: column; justify-content: center; }
        .hand-zone { height: 90px; display: flex; justify-content: center; gap: 5px; align-items: flex-end; margin-bottom: 5px; }
        .field-zone { flex: 1; border: 1px dashed #333; margin: 2px 0; display: flex; justify-content: center; align-items: center; gap: 10px; background: rgba(255,255,255,0.02); min-height: 70px; }
        
        /* --- [CORE] ì¹´ë“œ ë””ìì¸ ìŠ¤íƒ€ì¼ --- */
        .card {
            width: 70px; height: 100px; /* ë¹„ìœ¨ ì¡°ì • */
            background: #222; border: 2px solid #555; border-radius: 6px;
            padding: 2px; font-size: 0.6em; cursor: pointer; position: relative; 
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 4px 8px rgba(0,0,0,0.6); transition: transform 0.2s;
            overflow: hidden;
        }
        .card:active { transform: scale(0.95); } 
        .card.locked { filter: grayscale(100%); opacity: 0.5; pointer-events: none; }
        
        /* ê¸°ë³¸ ì¹´ë“œ (ì´ë¯¸ì§€ ì—†ì„ ë•Œ) */
        .card-name { font-weight: bold; color: #fff; text-align: center; line-height: 1.1; margin-top: 2px; word-break: break-all; z-index: 2;}
        .card-cost { position: absolute; top: 2px; right: 3px; color: #ffeb3b; font-weight: bold; font-size: 1.2em; z-index: 2; text-shadow: 1px 1px 0 #000;}
        .card-type { text-align: center; color: #aaa; font-size: 0.8em; margin-bottom: 2px; z-index: 2;}

        /* [NEW] ì´ë¯¸ì§€ ì ìš© ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card.full-art {
            background-color: transparent; border: none; box-shadow: none;
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        /* ì´ë¯¸ì§€ ì¹´ë“œì¼ ë•Œ í…ìŠ¤íŠ¸ ìˆ¨ê¹€ (ì´ë¯¸ì§€ ì•ˆì— í¬í•¨ë¨ì„ ê°€ì •, í•„ìš”ì‹œ ì£¼ì„ í•´ì œí•˜ì—¬ í‘œì‹œ ê°€ëŠ¥) */
        .card.full-art .card-name { display: none; }
        .card.full-art .card-cost { display: none; }
        .card.full-art .card-desc { display: none; }
        .card.full-art .card-type { display: none; }

        /* í•„ë“œ ì¹´ë“œ */
        .field-card {
            width: 50px; height: 70px; background: #1a1a1a; border: 2px solid #555; border-radius: 4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 5px rgba(0,0,0,0.5); position: relative;
        }
        /* ì´ë¯¸ì§€ í•„ë“œ ì¹´ë“œ */
        .field-card.full-art {
            background: transparent; border: none; 
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        .life-indicator { position: absolute; bottom: -15px; color: #00ffcc; font-size: 0.7em; white-space: nowrap; }

        /* ê¸°íƒ€ UI ìš”ì†Œë“¤ */
        .status-row { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; font-size: 0.8em;}
        .hp-text { font-size: 1.3em; font-weight: bold; color: #ff0055; }
        .energy-text { font-size: 1.1em; font-weight: bold; color: #ffeb3b; }
        .control-row { display: flex; justify-content: center; gap: 5px; margin: 2px 0; align-items: flex-start; }
        .dice-container { display: flex; flex-direction: column; align-items: center; }
        .dice-display { 
            background: #000; border: 1px solid #333; padding: 3px 5px; border-radius: 4px; 
            font-weight: bold; min-width: 90px; text-align: center; display: flex; gap: 8px; justify-content: center; 
            font-size: 0.9em;
        }
        
        .tuner-mod-ui { display: flex; gap: 8px; margin-top: 3px; justify-content: center; }
        .mod-btn { background: #222; border: 1px solid #00ccff; color: #00ccff; font-size: 0.6em; padding: 2px; cursor: pointer; width: 25px; }
        .confirm-btn { margin-top: 3px; background: #00ff66; color: #000; border: none; font-weight: bold; cursor: pointer; padding: 2px 8px; font-size: 0.7em; }
        button { background: #333; color: #fff; border: 1px solid #555; padding: 6px 10px; cursor: pointer; font-family: inherit; font-size: 0.8em; }
        button:hover { border-color: #00ffcc; color: #00ffcc; }
        button:disabled { opacity: 0.3; border-color: #333; color: #555; }
        
        #tooltip { 
            position: fixed; display: none; background: rgba(0,0,0,0.95); border: 1px solid #00ffcc; 
            padding: 10px; width: 200px; z-index: 6000; pointer-events: none; 
            top: 50% !important; left: 50% !important; transform: translate(-50%, -50%);
        }
        #tt-title { color: #00ffcc; margin: 0 0 5px 0; border-bottom: 1px solid #333; padding-bottom: 3px; }
        #tt-desc { color: #ccc; font-size: 0.85em; line-height: 1.4; margin: 0; }
        
        .float-text { position: absolute; font-weight: bold; font-size: 1.5em; pointer-events: none; z-index: 1500; text-shadow: 0 0 5px #000; animation: floatUp 1s ease-out forwards; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.5); opacity: 0; } }
        .dmg-pos { color: #ff3333; } .dmg-neg { color: #cc33ff; } .heal-pos { color: #00ff66; }
        .sound-wave { position: absolute; border-radius: 50%; border: 3px solid rgba(255, 255, 255, 0.8); box-shadow: 0 0 15px rgba(0, 255, 204, 0.5); opacity: 0; pointer-events: none; z-index: 1200; transform: translate(-50%, -50%); }
        @keyframes ripple-up { 0% { width: 0; height: 0; opacity: 0.8; top: 80%; } 100% { width: 150vw; height: 150vw; opacity: 0; top: 0%; } }
        @keyframes ripple-down { 0% { width: 0; height: 0; opacity: 0.8; top: 20%; } 100% { width: 150vw; height: 150vw; opacity: 0; top: 100%; } }
    </style>
</head>
<body>

<div id="app-frame">

    <div id="start-screen">
        <div class="title-logo">ğŸ¸ BATTLELICA</div>
        <div class="mode-select">
            <div class="mode-btn" id="mode-pvp" onclick="selectMode('pvp')">âš”ï¸ PvP Mode</div>
            <div class="mode-btn" id="mode-ai" onclick="selectMode('ai')">ğŸ¤– vs AI Mode</div>
        </div>
        <div class="deck-setup" id="deck-setup">
            <div class="player-select"><h3 id="p1-label">PLAYER 1</h3><select id="p1-deck-select"><option value="alt">ğŸŸ¦ ì–¼í„°ë„ˆí‹°ë¸Œ</option><option value="metal">ğŸŸ¥ í—¤ë¹„ ë©”íƒˆ</option></select></div>
            <div class="player-select"><h3 id="p2-label">PLAYER 2</h3><select id="p2-deck-select"><option value="metal">ğŸŸ¥ í—¤ë¹„ ë©”íƒˆ</option><option value="alt">ğŸŸ¦ ì–¼í„°ë„ˆí‹°ë¸Œ</option></select></div>
        </div>
        <div class="start-btn-group">
            <button id="btn-start-game" onclick="startRoulette()">GAME START</button>
            <button id="btn-collection" class="secondary-btn" onclick="openCollection()">ğŸ“– CARD COLLECTION</button>
            <button id="btn-rules" class="secondary-btn" onclick="openRules()">ğŸ“œ GAME RULES</button>
        </div>
    </div>

    <div id="collection-screen">
        <div class="collection-header">
            <div style="font-weight:bold; color:#00ffcc; font-size:1.2em;">CARD COLLECTION</div>
            <button class="close-btn" onclick="closeCollection()">X</button>
        </div>
        <div class="collection-body" id="collection-body"></div>
    </div>

    <div id="rule-screen">
        <div class="rule-header"><div class="rule-title">GUIDE BOOK</div><button class="close-rule-btn" onclick="closeRules()">X ë‹«ê¸°</button></div>
        <div class="rule-body">
            <div class="rule-section">
                <h3>ğŸ›ï¸ 2. íŠœë„ˆ (Tuner) ìƒì„¸ ë§¤ë‰´ì–¼</h3>
                <p>íŠœë„ˆëŠ” 3ê°œì˜ ì£¼ì‚¬ìœ„ë¡œ êµ¬ì„±ë˜ë©°, ê°ê° ê¸°íƒ€ì˜ ì¤„(String)ì„ ìƒì§•í•©ë‹ˆë‹¤.</p>
                <table class="tuner-table">
                    <thead><tr><th>ì£¼ì‚¬ìœ„</th><th>ì„¤ëª…</th></tr></thead>
                    <tbody>
                        <tr><td class="d6-col"><strong>1d6</strong></td><td><strong>ê³ ìŒ:</strong> ë³´ë„ˆìŠ¤ê°€ ì‘ì§€ë§Œ ì„±ê³µí•˜ê¸° ì‰½ê±°ë‚˜, ì‹¤íŒ¨ ì‹œ ë¦¬ìŠ¤í¬ê°€ í¼.</td></tr>
                        <tr><td class="d10-col"><strong>1d10</strong></td><td><strong>ì¤‘ìŒ:</strong> ì ì ˆí•œ í™•ë¥ ë¡œ ì¤€ìˆ˜í•œ ê³µê²©ë ¥.</td></tr>
                        <tr><td class="d20-col"><strong>1d20</strong></td><td><strong>ì €ìŒ:</strong> ì„±ê³µ í™•ë¥  ë‚®ì§€ë§Œ ê°•ë ¥í•œ í•œ ë°©.</td></tr>
                    </tbody>
                </table>
                <h4>ğŸŸ¦ Standard Tuning (ì–¼í„°ë„ˆí‹°ë¸Œ)</h4>
                <ul><li>ğŸ”´ 1d6 (4â†‘): +1</li><li>ğŸ”µ 1d10 (6â†‘): +2</li><li>ğŸŸ¡ 1d20 (15â†‘): +5</li></ul>
                <h4>ğŸŸ¥ Drop-C Tuning (í—¤ë¹„ ë©”íƒˆ)</h4>
                <ul><li>ğŸ”´ 1d6 (1~3): <span style="color:red">ìí•´ 3</span> / (4â†‘): +3</li><li>ğŸ”µ 1d10 (7â†‘): +4</li><li>ğŸŸ¡ 1d20 (18â†‘): +10</li></ul>
            </div>
        </div>
    </div>

    <div id="roulette-overlay"><div style="color:#aaa;">ì„ ê³µ ê²°ì • ì¤‘...</div><div class="roulette-box" id="roulette-text">PLAYER 1</div></div>
    <div id="gameover-overlay"><div class="winner-text" id="winner-text"></div><button id="btn-restart" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button></div>
    <div id="tooltip"><h4 id="tt-title"></h4><p id="tt-desc"></p><div id="tt-info" style="color:#ffeb3b; font-size:0.8em; margin-top:5px;"></div></div>

    <div id="game-container">
        <div id="p2-area" class="player-area inactive-turn">
            <div class="status-row"><div><span style="color:#00ccff" id="p2-name-display">P2</span> <span id="p2-deck-name" style="font-size:0.7em;"></span></div><div class="hp-text">HP:<span id="p2-hp">150</span></div><div class="energy-text">âš¡<span id="p2-energy">0</span></div></div>
            <div class="hand-zone" id="p2-hand"></div>
            <div class="control-row">
                <button id="p2-btn-tuner" onclick="actions.rollTuner('p2')">ğŸ²</button>
                <div class="dice-container">
                    <div class="dice-display"><span id="p2-d6">-</span><span id="p2-d10">-</span><span id="p2-d20">-</span></div>
                    <div id="p2-mod-ui" class="tuner-mod-ui" style="visibility: hidden;"><button class="mod-btn" onclick="actions.modTuner('p2', 0)">-1</button><button class="mod-btn" onclick="actions.modTuner('p2', 1)">-1</button><button class="mod-btn" onclick="actions.modTuner('p2', 2)">-1</button></div>
                    <button id="p2-mod-confirm" class="confirm-btn" style="display:none;" onclick="actions.confirmTuner('p2')">OK</button>
                </div>
                <button id="p2-btn-attack" onclick="actions.attack('p2')" disabled>âš”ï¸</button>
            </div>
            <div class="field-zone" id="p2-field"></div>
        </div>
        <div id="center-area"><div id="game-log"></div><div id="tuner-guide"><div style="color:#00ffcc; font-weight:bold; border-bottom:1px solid #444; margin-bottom:2px;">MANUAL</div><div id="guide-content"></div></div></div>
        <div id="p1-area" class="player-area active-turn">
            <div class="field-zone" id="p1-field"></div>
            <div class="control-row">
                <button id="p1-btn-tuner" onclick="actions.rollTuner('p1')">ğŸ²</button>
                <div class="dice-container">
                    <div class="dice-display"><span id="p1-d6">-</span><span id="p1-d10">-</span><span id="p1-d20">-</span></div>
                    <div id="p1-mod-ui" class="tuner-mod-ui" style="visibility: hidden;"><button class="mod-btn" onclick="actions.modTuner('p1', 0)">-1</button><button class="mod-btn" onclick="actions.modTuner('p1', 1)">-1</button><button class="mod-btn" onclick="actions.modTuner('p1', 2)">-1</button></div>
                    <button id="p1-mod-confirm" class="confirm-btn" style="display:none;" onclick="actions.confirmTuner('p1')">OK</button>
                </div>
                <button id="p1-btn-attack" onclick="actions.attack('p1')" disabled>âš”ï¸</button>
            </div>
            <div class="hand-zone" id="p1-hand"></div>
            <div class="status-row"><div><span style="color:#00ffcc" id="p1-name-display">P1</span> <span id="p1-deck-name" style="font-size:0.7em;"></span></div><div class="hp-text">HP:<span id="p1-hp">150</span></div><div class="energy-text">âš¡<span id="p1-energy">0</span></div></div>
        </div>
    </div>

</div> <script>
    function openRules() { document.getElementById('rule-screen').style.display = 'flex'; }
    function closeRules() { document.getElementById('rule-screen').style.display = 'none'; }
    
    // --- ë„ê° ê¸°ëŠ¥ ---
    function openCollection() {
        const screen = document.getElementById('collection-screen');
        const body = document.getElementById('collection-body');
        body.innerHTML = '';
        
        const decks = { "ğŸŸ¦ ì–¼í„°ë„ˆí‹°ë¸Œ ë±": DECKS.alt, "ğŸŸ¥ í—¤ë¹„ ë©”íƒˆ ë±": DECKS.metal };
        
        for (const [name, list] of Object.entries(decks)) {
            const section = document.createElement('div');
            section.className = 'deck-section';
            section.innerHTML = `<div class="deck-title">${name}</div>`;
            const grid = document.createElement('div');
            grid.className = 'card-grid';
            
            const uniqueCards = [];
            const seen = new Set();
            list.forEach(c => { if(!seen.has(c.name)){ seen.add(c.name); uniqueCards.push(c); }});

            uniqueCards.forEach(c => {
                const wrapper = document.createElement('div');
                wrapper.className = 'collection-card-wrapper';
                wrapper.appendChild(createCardElement(c));
                grid.appendChild(wrapper);
            });
            section.appendChild(grid);
            body.appendChild(section);
        }
        screen.style.display = 'flex';
    }
    function closeCollection() { document.getElementById('collection-screen').style.display = 'none'; }

    // [ë± ë°ì´í„°] - ì´ë¯¸ì§€ ì ìš©
    const DECKS = {
        alt: [
            ...Array(3).fill({name:"ë£¨í‚¤", type:"eff_atk", cost:1, val:5, life:2, color:"#ff5555", desc:"[OD] ë§¤í„´ 5 ë°ë¯¸ì§€.", img:"OD_rookie.png"}),
            ...Array(3).fill({name:"ë² í…Œë‘", type:"eff_atk", cost:2, val:10, life:2, color:"#ff5555", desc:"ë§¤í„´ 10 ë°ë¯¸ì§€.", img:"OD_veteran.png"}),
            ...Array(1).fill({name:"ë§ˆìŠ¤í„°", type:"eff_atk", cost:5, val:25, life:2, color:"#ff5555", desc:"[OD] ë§¤í„´ 25 ë°ë¯¸ì§€.", img:"OD_master.png"}),
            ...Array(2).fill({name:"ë¦¬ìŠ¤í‚¤", type:"eff_risky", cost:2, val:25, fail:5, life:2, color:"#ff0000", desc:"[Dist] ë§¤í„´ 30%í™•ë¥  25ë€."}),
            ...Array(1).fill({name:"í”¼ì–´ìŠ¤", type:"eff_pierce", cost:3, val:12, life:2, color:"#cc0000", desc:"[Fuzz] ë§¤í„´ 12 ê´€í†µ."}),
            ...Array(1).fill({name:"í‚µìº„", type:"eff_delay", cost:5, val:60, life:2, color:"#ffee00", desc:"[Delay] ì´ë²ˆ í„´ ê³µê²©ë¶ˆê°€, ë‹¤ìŒ í„´ 60."}),
            ...Array(2).fill({name:"í„°í‹€", type:"eff_def", cost:1, val:5, life:2, color:"#00ccff", desc:"[Phaser] ë§¤í„´ ë°©ì–´ +5."}),
            ...Array(1).fill({name:"ì†Œí”„í‹°", type:"eff_heal", cost:1, val:4, life:2, color:"#00ccff", desc:"[Chorus] ë§¤í„´ ì²´ë ¥ +4."}),
            ...Array(1).fill({name:"ë„ˆì§€", type:"eff_nudge", cost:1, val:0, life:2, color:"#00ccff", desc:"[Comp] íŠœë„ˆê°’ -1 ë³´ì •."}),
            ...Array(1).fill({name:"í”Œë¦½", type:"eff_buff", cost:2, val:5, life:2, color:"#00ccff", desc:"[Oct] ë§¤í„´ ê³µê²© +5."}),
            ...Array(2).fill({name:"ì¹ ë¦¬", type:"inst_heal", cost:1, val:10, color:"#aaaaaa", desc:"ì¦‰ì‹œ ì²´ë ¥ 10 íšŒë³µ."}),
            ...Array(3).fill({name:"ì†Œí˜•ê±´ì „ì§€", type:"inst_energy", cost:0, val:1, color:"#ffff00", desc:"ì—ë„ˆì§€ +1"}),
            ...Array(2).fill({name:"ì¤‘í˜•ê±´ì „ì§€", type:"inst_energy", cost:2, val:3, color:"#ffff00", desc:"ì—ë„ˆì§€ +3"}),
            ...Array(3).fill({name:"ìŠ¬ë¼ì´ë”©", type:"inst_draw", cost:1, val:1, color:"#aaaaaa", desc:"1ì¥ ë“œë¡œìš°."}),
            ...Array(2).fill({name:"í•´ë¨¸ë§", type:"inst_draw", cost:0, val:1, color:"#aaaaaa", desc:"ë± ì¡°ì‘."}),
            ...Array(2).fill({name:"ë„ˆì§€(ë²„í”„)", type:"eff_nudge", cost:1, val:0, life:2, color:"#00ccff", desc:"[Comp] íŠœë„ˆê°’ -1 ë³´ì •."})
        ],
        metal: [
            ...Array(3).fill({name:"ë£¨í‚¤", type:"eff_atk", cost:1, val:5, life:2, color:"#ff5555", desc:"ë§¤í„´ 5 ë°ë¯¸ì§€.", img:"OD_rookie.png"}),
            ...Array(4).fill({name:"í•˜ì´ê²Œì¸", type:"eff_self", cost:2, val:12, self:4, life:2, color:"#ff0000", desc:"ë§¤í„´ 12ë€ / ë‚˜ì—ê²Œ 4ë€."}),
            ...Array(3).fill({name:"ë¦¬ìŠ¤í‚¤", type:"eff_risky", cost:2, val:25, fail:5, life:2, color:"#ff0000", desc:"ë§¤í„´ 30%í™•ë¥  25ë€."}),
            ...Array(2).fill({name:"í”¼ì–´ìŠ¤", type:"eff_pierce", cost:3, val:10, life:2, color:"#cc0000", desc:"ë§¤í„´ 10 ê´€í†µ."}),
            ...Array(1).fill({name:"ë°ìŠ¤ë©”íƒˆ", type:"eff_atk", cost:5, val:20, life:2, color:"#ff5555", desc:"ë§¤í„´ 20 ë°ë¯¸ì§€."}),
            ...Array(3).fill({name:"ë…¸ì´ì¦ˆê²Œì´íŠ¸", type:"eff_gate", cost:1, val:4, life:2, color:"#00ccff", desc:"ë§¤í„´ 4ì´í•˜ ë¬´íš¨í™”."}),
            ...Array(1).fill({name:"í”Œë¦½", type:"eff_buff", cost:2, val:5, life:2, color:"#00ccff", desc:"ë§¤í„´ ê³µê²©ë³´ì • +5."}),
            ...Array(2).fill({name:"ìŠ¤ë˜ì‰¬", type:"inst_thrash", cost:4, val:12, color:"#ffffff", desc:"íŒ¨ ë²„ë¦¼. ì¥ë‹¹ 12ë€."}),
            ...Array(3).fill({name:"íŒœë®¤íŠ¸", type:"inst_buff", cost:1, val:5, color:"#aaaaaa", desc:"ì´ë²ˆ í„´ ê³µê²© +5."}),
            ...Array(3).fill({name:"ì†Œí˜•ê±´ì „ì§€", type:"inst_energy", cost:0, val:1, color:"#ffff00", desc:"ì—ë„ˆì§€ +1"}),
            ...Array(3).fill({name:"ì˜¤ë²„íˆíŠ¸", type:"inst_eng_harm", cost:0, val:2, self:5, color:"#ffaa00", desc:"ì—ë„ˆì§€ +2 / ë‚˜ -5."}),
            ...Array(2).fill({name:"ìŠ¬ë¼ì´ë”©", type:"inst_draw", cost:1, val:1, color:"#aaaaaa", desc:"1ì¥ ë“œë¡œìš°."})
        ]
    };

    let game = { mode: 'pvp', aiId: null };
    let animating = false;
    let tempDice = { d6:0, d10:0, d20:0 };
    let activeNudges = 0;

    // --- ì‹œê° íš¨ê³¼/ê¸°íƒ€ í•¨ìˆ˜ ---
    function showFloatingText(targetId, text, type) {
        const area = document.getElementById(`${targetId}-area`);
        const el = document.createElement('div');
        el.className = `float-text ${type}`; el.innerText = text;
        el.style.left = '50%'; el.style.top = '50%'; el.style.transform = 'translate(-50%, -50%)';
        area.appendChild(el); setTimeout(() => el.remove(), 1000);
    }
    function showAttackWave(attackerId) {
        const gameContainer = document.getElementById('game-container');
        const wave = document.createElement('div'); wave.className = 'sound-wave'; wave.style.left = '50%';
        if(attackerId === 'p1') wave.style.animation = 'ripple-up 0.6s ease-out forwards';
        else wave.style.animation = 'ripple-down 0.6s ease-out forwards';
        gameContainer.appendChild(wave); setTimeout(() => wave.remove(), 600);
    }
    function createCardElement(c, isPlayable=false, onClick=null) {
        const el = document.createElement('div'); el.className = 'card';
        if (c.img) {
            el.classList.add('full-art'); el.style.backgroundImage = `url('${c.img}')`;
            el.innerHTML = `<div class="card-name"></div><div class="card-cost"></div><div class="card-desc"></div>`;
        } else {
            el.style.borderColor = c.color;
            el.innerHTML = `<div class="card-name">${c.name}</div><div class="card-cost">âš¡${c.cost}</div><div class="card-type">${c.type.split('_')[1]||'skill'}</div>`;
        }
        if (isPlayable && onClick) el.onclick = onClick;
        else el.onclick = (e) => { showTooltip(e, c); setTimeout(hideTooltip, 1500); };
        el.onmouseenter = e => showTooltip(e, c); el.onmouseleave = hideTooltip;
        return el;
    }

    // --- ê²Œì„ ë¡œì§ ---
    function selectMode(mode) {
        game.mode = mode;
        document.getElementById('mode-pvp').classList.remove('selected');
        document.getElementById('mode-ai').classList.remove('selected');
        document.getElementById(`mode-${mode}`).classList.add('selected');
        document.getElementById('deck-setup').classList.add('visible');
        document.getElementById('btn-start-game').classList.add('visible');
        if(mode === 'ai') { document.getElementById('p1-label').innerText = "MY DECK"; document.getElementById('p2-label').innerText = "AI DECK"; } 
        else { document.getElementById('p1-label').innerText = "PLAYER 1"; document.getElementById('p2-label').innerText = "PLAYER 2"; }
    }
    function startRoulette() {
        document.getElementById('start-screen').style.display = 'none';
        const overlay = document.getElementById('roulette-overlay');
        const text = document.getElementById('roulette-text');
        overlay.style.display = 'flex';
        let count = 0, speed = 50, currentP = 1;
        const interval = setInterval(() => {
            currentP = currentP === 1 ? 2 : 1;
            text.innerText = game.mode === 'ai' ? (currentP===1 ? "YOU" : "AI") : `PLAYER ${currentP}`;
            text.className = `roulette-box roulette-p${currentP}`;
            count++;
            if (count > 20) speed += 20; 
            if (count > 30) { clearInterval(interval); finalizeStart(currentP === 1 ? 'p1' : 'p2'); }
        }, 100);
    }
    function finalizeStart(firstPlayer) {
        setTimeout(() => {
            document.getElementById('roulette-overlay').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            startGame(firstPlayer);
        }, 1000);
    }
    function startGame(activePid) {
        const p1Type = document.getElementById('p1-deck-select').value;
        const p2Type = document.getElementById('p2-deck-select').value;
        game.p1 = new Player('p1', p1Type); game.p2 = new Player('p2', p2Type);
        game.turn = 1; game.active = activePid;
        if (game.mode === 'ai') { game.aiId = 'p2'; document.getElementById('p1-name-display').innerText = "YOU"; document.getElementById('p2-name-display').innerText = "AI"; }
        document.getElementById('p1-deck-name').innerText = p1Type.toUpperCase();
        document.getElementById('p2-deck-name').innerText = p2Type.toUpperCase();
        log("=== BATTLE START ===");
        const second = activePid === 'p1' ? 'p2' : 'p1';
        setTimeout(() => {
            log(`ğŸ€ í›„ê³µ ëŸ­í‚¤ë°°í„°ë¦¬...`);
            if(Math.random() < 0.5) { game[second].energy += 1; log("ğŸ‰ ì„±ê³µ! +1 Energy"); showFloatingText(second, "+1 ENERGY", "heal-pos"); } else log("ğŸ’¨ ì‹¤íŒ¨.");
            game.p1.draw(5); game.p2.draw(5); startTurn();
        }, 800);
    }

    class Player {
        constructor(id, type) {
            this.id = id; this.type = type; this.hp = 150; this.energy = 0;
            this.deck = JSON.parse(JSON.stringify(DECKS[type])).sort(()=>Math.random()-0.5);
            this.deck.forEach(c => c.uid = Math.random());
            this.hand = []; this.field = []; this.trash = [];
            this.turnStats = { atk:0, def:0, gate:0 }; 
            this.tunerRolled = false;
            this.skipAttack = false; // í‚µìº„ ë“± ê³µê²© ë¶ˆê°€ í”Œë˜ê·¸
        }
        draw(n) {
            for(let i=0; i<n; i++) {
                if(this.hand.length>=6) break;
                if(!this.deck.length) { if(!this.trash.length) break; this.deck = this.trash.sort(()=>Math.random()-0.5); this.trash=[]; log("ğŸ”„ ë± ë¦¬í•„"); }
                this.hand.push(this.deck.pop());
            }
        }
    }

    function startTurn() {
        const p = game[game.active]; 
        p.energy = Math.min(10, p.energy+1); 
        p.draw(1); 
        p.tunerRolled = false; 
        p.skipAttack = false; // í„´ ì‹œì‘ì‹œ ì´ˆê¸°í™”
        p.turnStats = { atk:0, def:0, gate:0 };
        
        document.getElementById(`${game.active}-d6`).innerText = "-"; 
        document.getElementById(`${game.active}-d10`).innerText = "-"; 
        document.getElementById(`${game.active}-d20`).innerText = "-";
        document.getElementById('p1-mod-ui').style.visibility = 'hidden'; document.getElementById('p2-mod-ui').style.visibility = 'hidden';
        document.getElementById('p1-mod-confirm').style.display = 'none'; document.getElementById('p2-mod-confirm').style.display = 'none';
        
        updateGuide(p.type);
        log(`\n=== TURN ${game.turn} : ${game.active.toUpperCase()} ===`);
        
        let heal = 0;
        p.field.forEach(item => {
            const c = item.card;
            if(c.type === 'eff_def') p.turnStats.def += c.val;
            if(c.type === 'eff_gate') p.turnStats.gate = Math.max(p.turnStats.gate, c.val);
            if(c.type === 'eff_buff') p.turnStats.atk += c.val;
            if(c.type === 'eff_heal') heal += c.val;
        });
        if(heal > 0) { p.hp = Math.min(150, p.hp + heal); log(`ğŸ’š í•„ë“œ íš¨ê³¼: +${heal} HP`); showFloatingText(game.active, `+${heal}`, "heal-pos"); }
        
        render();
        if(game.mode === 'ai' && game.active === game.aiId) setTimeout(aiAction, 1000);
    }

    // AI ë¡œì§
    function aiAction() {
        const ai = game.p2; const handIndices = ai.hand.map((_, i) => i);
        for (let i of handIndices) {
            const c = ai.hand[i]; if (!c) continue; 
            if(c.type.startsWith('eff_') && ai.field.length >= 3) continue;
            if (c.cost <= ai.energy) { actions.playCard(game.active, i); setTimeout(aiAction, 800); return; }
        }
        if (!ai.tunerRolled) { actions.rollTuner(game.active); setTimeout(() => { if(activeNudges > 0) actions.confirmTuner(game.active); setTimeout(() => actions.attack(game.active), 500); }, 1500); }
        else if (ai.skipAttack) { setTimeout(() => actions.attack(game.active), 1000); } // í‚µìº„ ìƒíƒœì¼ ë•Œ ë°”ë¡œ ê³µê²©
    }

    const actions = {
        rollTuner: (pid) => {
            if(game.active !== pid || animating) return;
            const p = game[pid]; if(p.tunerRolled) return;
            animating = true; document.getElementById(`${pid}-btn-tuner`).disabled = true; p.tunerRolled = true; render(); 
            let count=0; const intv = setInterval(()=>{
                document.getElementById(`${pid}-d6`).innerText = r(6); document.getElementById(`${pid}-d10`).innerText = r(10); document.getElementById(`${pid}-d20`).innerText = r(20);
                count++; if(count>10) { clearInterval(intv); startNudgePhase(pid); }
            }, 50);
        },
        modTuner: (pid, diceIdx) => {
            if(activeNudges <= 0) return alert("ë³´ì • íšŸìˆ˜ ì†Œì§„!");
            const keys = ['d6','d10','d20']; const key = keys[diceIdx];
            if(tempDice[key] > 1) { tempDice[key]--; activeNudges--; document.getElementById(`${pid}-${key}`).innerText = tempDice[key]; log(`ğŸ”§ ë„ˆì§€ -1 (${activeNudges}íšŒ)`); if(activeNudges <= 0) document.getElementById(`${pid}-mod-ui`).style.visibility = 'hidden'; }
        },
        confirmTuner: (pid) => { document.getElementById(`${pid}-mod-ui`).style.visibility = 'hidden'; document.getElementById(`${pid}-mod-confirm`).style.display = 'none'; finalizeTuner(pid); },
        
        attack: (pid) => {
            if(game.active !== pid || animating) return;
            const p = game[pid]; 
            
            // [NEW] í‚µìº„ ë“±ìœ¼ë¡œ ê³µê²© ê¸ˆì§€ ìƒíƒœì¼ ê²½ìš°
            if(p.skipAttack) {
                log("ğŸ’¤ í‚µìº„ ì¶©ì „ ì¤‘... (ê³µê²© 0)");
                setTimeout(() => endTurn(pid), 600);
                return;
            }

            const opp = game[pid==='p1'?'p2':'p1']; const oppId = pid==='p1'?'p2':'p1';
            showAttackWave(pid);
            let totalDmg = p.turnStats.atk; let pierceDmg = 0; let selfDmg = 0;
            p.field.forEach(item => {
                const c = item.card;
                if(c.type === 'eff_delay') { if(item.life === 1) { log(`ğŸ’¥ í‚µìº„ í­ë°œ!`); totalDmg += c.val; } }
                else if(c.type === 'eff_atk') totalDmg += c.val;
                else if(c.type === 'eff_self') { totalDmg += c.val; selfDmg += c.self; }
                else if(c.type === 'eff_pierce') pierceDmg += c.val;
                else if(c.type === 'eff_risky') { if(Math.random() < 0.3) { log(`âš¡ ë¦¬ìŠ¤í‚¤ ëŒ€ë°•!`); totalDmg += c.val; } else totalDmg += c.fail; }
            });
            if(selfDmg > 0) { p.hp -= selfDmg; log(`ğŸ©¸ ê³¼ë¶€í•˜ -${selfDmg}`); showFloatingText(pid, `-${selfDmg}`, "dmg-neg"); }
            let oppDef = 0; let oppGate = 0;
            opp.field.forEach(item => { if(item.card.type === 'eff_def') oppDef += item.card.val; if(item.card.type === 'eff_gate') oppGate = Math.max(oppGate, item.card.val); });
            if(pierceDmg > 0) { if(pierceDmg > oppGate) { opp.hp -= pierceDmg; log(`ğŸ—¡ï¸ ê´€í†µ ${pierceDmg}`); showFloatingText(oppId, `+${pierceDmg}`, "dmg-pos"); } else log(`ğŸ›¡ï¸ ê²Œì´íŠ¸ ë°©ì–´`); }
            let final = Math.max(0, totalDmg - oppDef);
            if(final <= oppGate && final > 0) { final = 0; log(`ğŸ›¡ï¸ ê²Œì´íŠ¸ ë°©ì–´!`); }
            if(final > 0) { opp.hp -= final; log(`âš”ï¸ ì ì¤‘ ${final}`); showFloatingText(oppId, `+${final}`, "dmg-pos"); } else if(totalDmg > 0) log(`ğŸ›¡ï¸ ë°©ì–´ë¨`);
            if(p.hp<=0) gameOver(pid==='p1'?'p2':'p1'); else if(opp.hp<=0) gameOver(pid); else setTimeout(() => endTurn(pid), 600);
        },
        
        playCard: (pid, idx) => {
            if(game.active !== pid || animating) return;
            const p = game[pid]; 
            if(p.tunerRolled) return alert("ì´ë¯¸ íŠœë„ˆë¥¼ êµ´ë ¸ê±°ë‚˜ ê³µê²© ëŒ€ê¸° ìƒíƒœì…ë‹ˆë‹¤.");
            
            const c = p.hand[idx]; 
            if(p.energy < c.cost) { if(game.mode!=='ai' || game.active!=='p2') alert("ì—ë„ˆì§€ ë¶€ì¡±"); return; }
            
            p.energy -= c.cost; p.hand.splice(idx, 1); hideTooltip(); log(`â–¶ [${c.name}]`);
            
            if(c.type.startsWith('inst_')) {
                if(c.type==='inst_heal') { p.hp = Math.min(150, p.hp+c.val); showFloatingText(pid, `+${c.val}`, "heal-pos"); }
                if(c.type==='inst_energy') p.energy += c.val;
                if(c.type==='inst_eng_harm') { p.energy+=c.val; p.hp-=c.self; showFloatingText(pid, `-${c.self}`, "dmg-neg"); }
                if(c.type==='inst_draw') p.draw(c.val);
                if(c.type==='inst_buff') p.turnStats.atk += c.val;
                if(c.type==='inst_thrash') { const dmg = p.hand.length * c.val; p.hand = []; p.turnStats.atk += dmg; log(`ğŸ”¥ ìŠ¤ë˜ì‰¬ +${dmg}`); }
                p.trash.push(c);
            } else {
                if(p.field.length >= 3) { p.energy+=c.cost; p.hand.push(c); return alert("í•„ë“œ ê½‰ ì°¸"); }
                if(c.type==='eff_def') p.turnStats.def += c.val;
                if(c.type==='eff_gate') p.turnStats.gate = Math.max(p.turnStats.gate, c.val);
                if(c.type==='eff_buff') p.turnStats.atk += c.val;
                if(c.type==='eff_heal') { p.hp = Math.min(150, p.hp+c.val); showFloatingText(pid, `+${c.val}`, "heal-pos"); }
                
                // [NEW] í‚µìº„ ë¡œì§: ë‚´ëŠ” ìˆœê°„ íŠœë„ˆ ê¸ˆì§€ + ê³µê²© 0 ê³ ì •
                if(c.type==='eff_delay') {
                    p.tunerRolled = true; // íŠœë„ˆ ë²„íŠ¼ ë¹„í™œì„±í™”, ê³µê²© ë²„íŠ¼ í™œì„±í™”
                    p.skipAttack = true;  // ê³µê²© ì‹œ ë°ë¯¸ì§€ 0 ì²˜ë¦¬
                    alert("âš ï¸ í‚µìº„ ë°œë™! ì´ë²ˆ í„´ì€ íŠœë‹ ì—†ì´ ë°”ë¡œ í„´ì„ ì¢…ë£Œí•´ì•¼ í•©ë‹ˆë‹¤.");
                }
                
                p.field.push({ card: c, life: 2 });
            }
            render();
        }
    };

    // (ì´í•˜ í•¨ìˆ˜ë“¤ ë™ì¼: startNudgePhase, finalizeTuner, endTurn, gameOver, updateGuide, render, renderP...)
    function startNudgePhase(pid) {
        const p = game[pid]; tempDice = { d6: r(6), d10: r(10), d20: r(20) };
        document.getElementById(`${pid}-d6`).innerText = tempDice.d6; document.getElementById(`${pid}-d10`).innerText = tempDice.d10; document.getElementById(`${pid}-d20`).innerText = tempDice.d20;
        activeNudges = 0; p.field.forEach(item => { if(item.card.type === 'eff_nudge') activeNudges++; });
        if(activeNudges > 0) {
            log(`ğŸ”§ ë„ˆì§€ ê°€ëŠ¥ (${activeNudges}íšŒ)`);
            if(game.mode === 'ai' && pid === 'p2') setTimeout(() => actions.confirmTuner(pid), 500);
            else { document.getElementById(`${pid}-mod-ui`).style.visibility = 'visible'; document.getElementById(`${pid}-mod-confirm`).style.display = 'inline-block'; }
        } else finalizeTuner(pid);
    }
    function finalizeTuner(pid) {
        const p = game[pid]; let bonus = 0; let self = 0; const d6 = tempDice.d6; const d10 = tempDice.d10; const d20 = tempDice.d20;
        if(p.type === 'alt') { if(d6>=4) bonus+=1; if(d10>=6) bonus+=2; if(d20>=15) bonus+=5; } 
        else { if(d6<=3) { self+=3; document.getElementById(`${pid}-d6`).style.color='red'; } else bonus+=3; if(d10>=7) bonus+=4; if(d20>=18) bonus+=10; }
        p.turnStats.atk += bonus;
        if(self>0) { p.hp -= self; log(`ğŸ©¸ ìí•´ -${self}`); showFloatingText(pid, `-${self}`, "dmg-neg"); }
        log(`ğŸ² í™•ì •: ê³µ +${bonus}`); if(p.hp<=0) gameOver(pid==='p1'?'p2':'p1'); animating = false; render();
    }
    function endTurn(pid) {
        const p = game[pid]; p.field = p.field.filter(item => { item.life--; if(item.life <= 0) { p.trash.push(item.card); return false; } return true; });
        game.turn++; game.active = pid==='p1'?'p2':'p1'; startTurn();
    }
    function gameOver(winnerId) {
        const name = (game.mode==='ai' && winnerId==='p1') ? "YOU" : (game.mode==='ai' && winnerId==='p2') ? "AI" : (winnerId==='p1' ? "PLAYER 1" : "PLAYER 2");
        document.getElementById('winner-text').innerText = `${name} WINS!`; document.getElementById('gameover-overlay').style.display = 'flex';
    }
    function updateGuide(type) {
        const el = document.getElementById('guide-content');
        if(type === 'alt') el.innerHTML = `<div>1d6(4â†‘):+1</div><div>1d10(6â†‘):+2</div><div>1d20(15â†‘):+5</div>`;
        else el.innerHTML = `<div style="color:red">1d6(3â†“):ìí•´3</div><div>1d6(4â†‘):+3</div><div>1d10(7â†‘):+4</div><div>1d20(18â†‘):+10</div>`;
    }
    function render() {
        renderP('p1'); renderP('p2');
        document.getElementById('p1-area').className = `player-area ${game.active==='p1'?'active-turn':'inactive-turn'}`;
        document.getElementById('p2-area').className = `player-area ${game.active==='p2'?'active-turn':'inactive-turn'}`;
    }
    function renderP(pid) {
        const p = game[pid];
        document.getElementById(`${pid}-hp`).innerText = p.hp;
        document.getElementById(`${pid}-energy`).innerText = p.energy;
        const isMyTurn = game.active === pid;
        const isHumanControl = (game.mode === 'pvp') || (game.mode === 'ai' && pid === 'p1');
        document.getElementById(`${pid}-btn-tuner`).disabled = !isMyTurn || p.tunerRolled || !isHumanControl;
        document.getElementById(`${pid}-btn-attack`).disabled = !isMyTurn || !p.tunerRolled || !isHumanControl;
        const h = document.getElementById(`${pid}-hand`); h.innerHTML = '';
        p.hand.forEach((c, i) => {
            const el = createCardElement(c, true, () => {
                if(isMyTurn && !p.tunerRolled && isHumanControl) actions.playCard(pid, i);
            });
            if(p.tunerRolled) el.classList.add('locked');
            h.appendChild(el);
        });
        const f = document.getElementById(`${pid}-field`); f.innerHTML = '';
        p.field.forEach(item => {
            const el = document.createElement('div'); el.className = 'field-card';
            if(item.card.img) { el.classList.add('full-art'); el.style.backgroundImage = `url('${item.card.img}')`; el.innerHTML = `<div class="life-indicator">${"â—".repeat(item.life)}</div>`; } 
            else { el.style.borderColor = item.card.color; el.innerHTML = `<div style="font-size:0.7em;color:#fff">${item.card.name}</div><div class="life-indicator">${"â—".repeat(item.life)}</div>`; }
            el.onclick = (e) => { showTooltip(e, item.card); setTimeout(hideTooltip, 1500); }; f.appendChild(el);
        });
    }
    function r(n) { return Math.ceil(Math.random()*n); }
    const tooltip = document.getElementById('tooltip');
    function showTooltip(e, c) { document.getElementById('tt-title').innerText = c.name; document.getElementById('tt-desc').innerText = c.desc; tooltip.style.display = 'block'; }
    function hideTooltip() { tooltip.style.display='none'; }
    function log(msg) { const l = document.getElementById('game-log'); const d = document.createElement('div'); d.innerText = msg; l.prepend(d); }
    function openCollection() {
        const screen = document.getElementById('collection-screen'); const body = document.getElementById('collection-body'); body.innerHTML = '';
        const decks = { "ğŸŸ¦ ì–¼í„°ë„ˆí‹°ë¸Œ ë±": DECKS.alt, "ğŸŸ¥ í—¤ë¹„ ë©”íƒˆ ë±": DECKS.metal };
        for (const [name, list] of Object.entries(decks)) {
            const section = document.createElement('div'); section.className = 'deck-section'; section.innerHTML = `<div class="deck-title">${name}</div>`;
            const grid = document.createElement('div'); grid.className = 'card-grid';
            const uniqueCards = []; const seen = new Set();
            list.forEach(c => { if(!seen.has(c.name)){ seen.add(c.name); uniqueCards.push(c); }});
            uniqueCards.forEach(c => { const wrapper = document.createElement('div'); wrapper.className = 'collection-card-wrapper'; wrapper.appendChild(createCardElement(c)); grid.appendChild(wrapper); });
            section.appendChild(grid); body.appendChild(section);
        }
        screen.style.display = 'flex';
    }
    function closeCollection() { document.getElementById('collection-screen').style.display = 'none'; }
</script>
</body>
</html>
