<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>BATTLELICA: FINAL</title>
    <style>
        /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        body { background-color: #050505; color: #e0e0e0; font-family: 'Courier New', monospace; margin: 0; height: 100vh; overflow: hidden; user-select: none; }
        
        /* --- ì‹œì‘ í™”ë©´ --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .title-logo { font-size: 4em; font-weight: bold; color: #ff0055; text-shadow: 0 0 20px #ff0055, 2px 2px 0px #00ffcc; margin-bottom: 40px; letter-spacing: 8px; font-style: italic; }
        
        .mode-select { display: flex; gap: 20px; margin-bottom: 30px; }
        .mode-btn {
            padding: 15px 30px; font-size: 1.2em; border: 2px solid #555; background: #222; color: #aaa; cursor: pointer; transition: 0.3s;
        }
        .mode-btn.selected { border-color: #00ffcc; color: #00ffcc; background: #111; box-shadow: 0 0 15px rgba(0,255,204,0.3); }
        
        .deck-setup { display: flex; gap: 50px; margin-bottom: 40px; opacity: 0; transition: 0.5s; pointer-events: none; }
        .deck-setup.visible { opacity: 1; pointer-events: auto; }
        
        .player-select { text-align: center; border: 1px solid #333; padding: 20px; border-radius: 10px; background: #111; min-width: 200px; }
        .player-select h3 { color: #fff; border-bottom: 1px solid #555; padding-bottom: 10px; margin-top: 0; }
        select { background: #222; color: #fff; padding: 10px; border: 1px solid #00ffcc; font-size: 1.1em; cursor: pointer; width: 100%; }
        
        #btn-start-game {
            font-size: 1.5em; padding: 15px 50px; background: #ff0055; color: #fff; border: none; cursor: pointer;
            box-shadow: 0 0 20px #ff0055; transition: 0.3s; opacity: 0; pointer-events: none;
        }
        #btn-start-game.visible { opacity: 1; pointer-events: auto; }
        #btn-start-game:hover { transform: scale(1.05); background: #ff3377; }

        /* --- ì˜¤ë²„ë ˆì´ --- */
        #roulette-overlay, #gameover-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .roulette-box { font-size: 3em; font-weight: bold; padding: 20px 40px; border: 4px solid #fff; color: #fff; background: #000; min-width: 300px; text-align: center; }
        .winner-text { font-size: 4em; font-weight: bold; color: #ffeb3b; text-shadow: 0 0 30px #ffeb3b; margin-bottom: 20px; }
        #btn-restart { font-size: 1.5em; padding: 15px 40px; background: #fff; color: #000; border: none; cursor: pointer; }

        /* --- ê²Œì„ í™”ë©´ --- */
        #game-container { display: none; width: 100%; height: 100%; flex-direction: column; position: relative; overflow: hidden; }
        .player-area { flex: 1; padding: 10px; transition: all 0.5s ease; display: flex; flex-direction: column; border-bottom: 1px solid #333; position: relative; z-index: 10; }
        .active-turn { background-color: #1a1a1a; box-shadow: inset 0 0 30px rgba(0, 255, 204, 0.05); }
        .inactive-turn { background-color: #000; opacity: 0.5; pointer-events: none; filter: grayscale(80%); }

        /* ì¤‘ì•™ ì •ë³´ì°½ */
        #center-area { height: 140px; background: #080808; border-top: 1px solid #333; border-bottom: 1px solid #333; display: flex; z-index: 20; }
        #game-log { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.85em; color: #aaa; border-right: 1px solid #333; line-height: 1.4; }
        #tuner-guide { width: 180px; padding: 10px; font-size: 0.75em; color: #888; background: #0e0e0e; display: flex; flex-direction: column; justify-content: center; }
        .guide-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
        
        /* ì¹´ë“œ ë° í•„ë“œ */
        .hand-zone { height: 110px; display: flex; justify-content: center; gap: 8px; align-items: flex-end; }
        .field-zone { flex: 1; border: 1px dashed #333; margin: 5px 0; display: flex; justify-content: center; align-items: center; gap: 15px; background: rgba(255,255,255,0.02); }
        
        .card {
            width: 75px; height: 100px; background: #222; border: 1px solid #555; border-radius: 6px;
            padding: 5px; font-size: 0.7em; cursor: pointer; position: relative; display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5); transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-15px) scale(1.1); z-index: 100; border-color: #fff; }
        .card.locked { filter: grayscale(100%); opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        .card-name { font-weight: bold; color: #fff; text-align: center; line-height: 1.2; margin-top: 5px;}
        .card-cost { position: absolute; top: 3px; right: 5px; color: #ffeb3b; font-weight: bold; font-size: 1.1em; }
        
        .field-card {
            width: 60px; height: 80px; background: #1a1a1a; border: 2px solid #555; border-radius: 4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); position: relative;
        }
        .life-indicator { position: absolute; bottom: -20px; color: #00ffcc; font-size: 0.8em; }

        /* ìƒíƒœì°½ & ì»¨íŠ¸ë¡¤ */
        .status-row { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; }
        .hp-text { font-size: 1.5em; font-weight: bold; color: #ff0055; }
        .energy-text { font-size: 1.2em; font-weight: bold; color: #ffeb3b; }
        .control-row { display: flex; justify-content: center; gap: 10px; margin: 5px 0; align-items: flex-start; }
        
        .dice-container { display: flex; flex-direction: column; align-items: center; }
        .dice-display { background: #000; border: 1px solid #333; padding: 5px 10px; border-radius: 4px; font-weight: bold; min-width: 120px; text-align: center; display: flex; gap: 15px; justify-content: center; }
        
        /* íŠœë„ˆ ì¡°ì‘ UI (ë„ˆì§€ìš©) */
        .tuner-mod-ui { display: flex; gap: 15px; margin-top: 5px; justify-content: center; }
        .mod-btn { 
            background: #222; border: 1px solid #00ccff; color: #00ccff; font-size: 0.7em; padding: 2px 5px; cursor: pointer; width: 30px;
        }
        .mod-btn:hover { background: #00ccff; color: #000; }
        .confirm-btn {
            margin-top: 5px; background: #00ff66; color: #000; border: none; font-weight: bold; cursor: pointer; padding: 2px 10px; font-size: 0.8em;
        }

        button { background: #333; color: #fff; border: 1px solid #555; padding: 8px 16px; cursor: pointer; font-family: inherit; }
        button:hover { border-color: #00ffcc; color: #00ffcc; }
        button:disabled { opacity: 0.3; cursor: not-allowed; border-color: #333; color: #555; }

        /* íˆ´íŒ */
        #tooltip { position: fixed; display: none; background: rgba(0,0,0,0.95); border: 1px solid #00ffcc; padding: 10px; width: 220px; z-index: 2000; pointer-events: none; }
        #tt-title { color: #00ffcc; margin: 0 0 5px 0; border-bottom: 1px solid #333; padding-bottom: 3px; }
        #tt-desc { color: #ccc; font-size: 0.85em; line-height: 1.4; margin: 0; }

        /* ì‹œê° íš¨ê³¼ */
        .float-text {
            position: absolute; font-weight: bold; font-size: 2em; pointer-events: none; z-index: 1500;
            text-shadow: 0 0 5px #000;
            animation: floatUp 1s ease-out forwards;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
        }
        .dmg-pos { color: #ff3333; } 
        .dmg-neg { color: #cc33ff; } 
        .heal-pos { color: #00ff66; }

        .sound-wave {
            position: absolute;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.5);
            opacity: 0;
            pointer-events: none;
            z-index: 1200;
            transform: translate(-50%, -50%);
        }
        @keyframes ripple-up {
            0% { width: 0; height: 0; opacity: 0.8; top: 80%; }
            100% { width: 800px; height: 800px; opacity: 0; top: 20%; }
        }
        @keyframes ripple-down {
            0% { width: 0; height: 0; opacity: 0.8; top: 20%; }
            100% { width: 800px; height: 800px; opacity: 0; top: 80%; }
        }
    </style>
</head>
<body>

<div id="start-screen">
    <div class="title-logo">ğŸ¸ BATTLELICA</div>
    <div class="mode-select">
        <div class="mode-btn" id="mode-pvp" onclick="selectMode('pvp')">âš”ï¸ PvP Mode</div>
        <div class="mode-btn" id="mode-ai" onclick="selectMode('ai')">ğŸ¤– vs AI Mode</div>
    </div>
    <div class="deck-setup" id="deck-setup">
        <div class="player-select">
            <h3 id="p1-label">PLAYER 1</h3>
            <select id="p1-deck-select"><option value="alt">ğŸŸ¦ ì–¼í„°ë„ˆí‹°ë¸Œ ë±</option><option value="metal">ğŸŸ¥ í—¤ë¹„ ë©”íƒˆ ë±</option></select>
        </div>
        <div class="player-select">
            <h3 id="p2-label">PLAYER 2</h3>
            <select id="p2-deck-select"><option value="metal">ğŸŸ¥ í—¤ë¹„ ë©”íƒˆ ë±</option><option value="alt">ğŸŸ¦ ì–¼í„°ë„ˆí‹°ë¸Œ ë±</option></select>
        </div>
    </div>
    <button id="btn-start-game" onclick="startRoulette()">GAME START</button>
</div>

<div id="roulette-overlay">
    <div style="color:#aaa; font-size:1.5em; margin-bottom:20px;">ì„ ê³µ ê²°ì • ì¤‘...</div>
    <div class="roulette-box" id="roulette-text">PLAYER 1</div>
</div>

<div id="gameover-overlay">
    <div class="winner-text" id="winner-text">PLAYER 1 WINS!</div>
    <button id="btn-restart" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
</div>

<div id="tooltip"><h4 id="tt-title"></h4><p id="tt-desc"></p><div id="tt-info" style="color:#ffeb3b; font-size:0.8em; margin-top:5px;"></div></div>

<div id="game-container">
    <div id="p2-area" class="player-area inactive-turn">
        <div class="status-row">
            <div><span style="color:#00ccff" id="p2-name-display">PLAYER 2</span> <span id="p2-deck-name" style="font-size:0.7em;"></span></div>
            <div class="hp-text">HP: <span id="p2-hp">150</span></div>
            <div class="energy-text">âš¡ <span id="p2-energy">0</span></div>
        </div>
        <div class="hand-zone" id="p2-hand"></div>
        <div class="control-row">
            <button id="p2-btn-tuner" onclick="actions.rollTuner('p2')">ğŸ² íŠœë„ˆ</button>
            <div class="dice-container">
                <div class="dice-display"><span id="p2-d6">-</span><span id="p2-d10">-</span><span id="p2-d20">-</span></div>
                <div id="p2-mod-ui" class="tuner-mod-ui" style="visibility: hidden;">
                    <button class="mod-btn" onclick="actions.modTuner('p2', 0)">-1</button>
                    <button class="mod-btn" onclick="actions.modTuner('p2', 1)">-1</button>
                    <button class="mod-btn" onclick="actions.modTuner('p2', 2)">-1</button>
                </div>
                <button id="p2-mod-confirm" class="confirm-btn" style="display:none;" onclick="actions.confirmTuner('p2')">í™•ì¸</button>
            </div>
            <button id="p2-btn-attack" onclick="actions.attack('p2')" disabled>âš”ï¸ ê³µê²©</button>
        </div>
        <div class="field-zone" id="p2-field"></div>
    </div>

    <div id="center-area">
        <div id="game-log"></div>
        <div id="tuner-guide"><div style="color:#00ffcc; font-weight:bold; border-bottom:1px solid #444; margin-bottom:5px;">TUNER MANUAL</div><div id="guide-content"></div></div>
    </div>

    <div id="p1-area" class="player-area active-turn">
        <div class="field-zone" id="p1-field"></div>
        <div class="control-row">
            <button id="p1-btn-tuner" onclick="actions.rollTuner('p1')">ğŸ² íŠœë„ˆ</button>
            <div class="dice-container">
                <div class="dice-display"><span id="p1-d6">-</span><span id="p1-d10">-</span><span id="p1-d20">-</span></div>
                <div id="p1-mod-ui" class="tuner-mod-ui" style="visibility: hidden;">
                    <button class="mod-btn" onclick="actions.modTuner('p1', 0)">-1</button>
                    <button class="mod-btn" onclick="actions.modTuner('p1', 1)">-1</button>
                    <button class="mod-btn" onclick="actions.modTuner('p1', 2)">-1</button>
                </div>
                <button id="p1-mod-confirm" class="confirm-btn" style="display:none;" onclick="actions.confirmTuner('p1')">í™•ì¸</button>
            </div>
            <button id="p1-btn-attack" onclick="actions.attack('p1')" disabled>âš”ï¸ ê³µê²©</button>
        </div>
        <div class="hand-zone" id="p1-hand"></div>
        <div class="status-row">
            <div><span style="color:#00ffcc" id="p1-name-display">PLAYER 1</span> <span id="p1-deck-name" style="font-size:0.7em;"></span></div>
            <div class="hp-text">HP: <span id="p1-hp">150</span></div>
            <div class="energy-text">âš¡ <span id="p1-energy">0</span></div>
        </div>
    </div>
</div>

<script>
    // [ë± ë°ì´í„°: 'ë„ˆì§€' ìˆ˜ì •ë¨]
    const DECKS = {
        alt: [
            ...Array(3).fill({name:"ë£¨í‚¤", type:"eff_atk", cost:1, val:5, life:2, color:"#ff5555", desc:"[OD] ë§¤í„´ 5 ë°ë¯¸ì§€."}),
            ...Array(3).fill({name:"ë² í…Œë‘", type:"eff_atk", cost:2, val:10, life:2, color:"#ff5555", desc:"[OD] ë§¤í„´ 10 ë°ë¯¸ì§€."}),
            ...Array(2).fill({name:"ë¦¬ìŠ¤í‚¤", type:"eff_risky", cost:2, val:25, fail:5, life:2, color:"#ff0000", desc:"[Dist] ë§¤í„´ 30%í™•ë¥  25ë€ (ì‹¤íŒ¨ 5)."}),
            ...Array(1).fill({name:"í”¼ì–´ìŠ¤", type:"eff_pierce", cost:3, val:12, life:2, color:"#cc0000", desc:"[Fuzz] ë§¤í„´ 12 ê´€í†µ ë°ë¯¸ì§€."}),
            ...Array(1).fill({name:"ë§ˆìŠ¤í„°", type:"eff_atk", cost:5, val:25, life:2, color:"#ff5555", desc:"[OD] ë§¤í„´ 25 ë°ë¯¸ì§€."}),
            ...Array(1).fill({name:"í‚µìº„", type:"eff_delay", cost:5, val:60, life:2, color:"#ffee00", desc:"[Delay] 1í„´ ëŒ€ê¸° í›„ 2í„´ì§¸ 60 í­ë°œ."}),
            ...Array(2).fill({name:"í„°í‹€", type:"eff_def", cost:1, val:5, life:2, color:"#00ccff", desc:"[Phaser] ë§¤í„´ ë°©ì–´ +5."}),
            ...Array(1).fill({name:"ì†Œí”„í‹°", type:"eff_heal", cost:1, val:4, life:2, color:"#00ccff", desc:"[Chorus] ë§¤í„´ ì²´ë ¥ 4 íšŒë³µ."}),
            // ë„ˆì§€ ìˆ˜ì •: eff_nudge
            ...Array(1).fill({name:"ë„ˆì§€", type:"eff_nudge", cost:1, val:0, life:2, color:"#00ccff", desc:"[Comp] íŠœë„ˆ ì£¼ì‚¬ìœ„ê°’ -1 ë³´ì • ê°€ëŠ¥."}),
            ...Array(1).fill({name:"í”Œë¦½", type:"eff_buff", cost:2, val:5, life:2, color:"#00ccff", desc:"[Oct] ë§¤í„´ ê³µê²©ë³´ì • +5."}),
            ...Array(2).fill({name:"ì¹ ë¦¬", type:"inst_heal", cost:1, val:10, color:"#aaaaaa", desc:"ì¦‰ì‹œ ì²´ë ¥ 10 íšŒë³µ."}),
            ...Array(3).fill({name:"ì†Œí˜•ê±´ì „ì§€", type:"inst_energy", cost:0, val:1, color:"#ffff00", desc:"ì—ë„ˆì§€ +1"}),
            ...Array(2).fill({name:"ì¤‘í˜•ê±´ì „ì§€", type:"inst_energy", cost:2, val:3, color:"#ffff00", desc:"ì—ë„ˆì§€ +3"}),
            ...Array(3).fill({name:"ìŠ¬ë¼ì´ë”©", type:"inst_draw", cost:1, val:1, color:"#aaaaaa", desc:"1ì¥ ë“œë¡œìš°."}),
            ...Array(2).fill({name:"í•´ë¨¸ë§", type:"inst_draw", cost:0, val:1, color:"#aaaaaa", desc:"ë± ì¡°ì‘ (ë“œë¡œìš°ë¡œ êµ¬í˜„)."}),
            // ë„ˆì§€ ìˆ˜ì •
            ...Array(2).fill({name:"ë„ˆì§€(ë²„í”„)", type:"eff_nudge", cost:1, val:0, life:2, color:"#00ccff", desc:"[Comp] íŠœë„ˆ ì£¼ì‚¬ìœ„ê°’ -1 ë³´ì • ê°€ëŠ¥."})
        ],
        metal: [
            ...Array(3).fill({name:"ë£¨í‚¤", type:"eff_atk", cost:1, val:5, life:2, color:"#ff5555", desc:"ë§¤í„´ 5 ë°ë¯¸ì§€."}),
            ...Array(4).fill({name:"í•˜ì´ê²Œì¸", type:"eff_self", cost:2, val:12, self:4, life:2, color:"#ff0000", desc:"ë§¤í„´ 12ë€ / ë‚˜ì—ê²Œ 4ë€."}),
            ...Array(3).fill({name:"ë¦¬ìŠ¤í‚¤", type:"eff_risky", cost:2, val:25, fail:5, life:2, color:"#ff0000", desc:"ë§¤í„´ 30%í™•ë¥  25ë€ (ì‹¤íŒ¨ 5)."}),
            ...Array(2).fill({name:"í”¼ì–´ìŠ¤", type:"eff_pierce", cost:3, val:10, life:2, color:"#cc0000", desc:"ë§¤í„´ 10 ê´€í†µ ë°ë¯¸ì§€."}),
            ...Array(1).fill({name:"ë°ìŠ¤ë©”íƒˆ", type:"eff_atk", cost:5, val:20, life:2, color:"#ff5555", desc:"ë§¤í„´ 20 ë°ë¯¸ì§€."}),
            ...Array(3).fill({name:"ë…¸ì´ì¦ˆê²Œì´íŠ¸", type:"eff_gate", cost:1, val:4, life:2, color:"#00ccff", desc:"ë§¤í„´ 4ì´í•˜ ë°ë¯¸ì§€ ë¬´íš¨í™”."}),
            ...Array(1).fill({name:"í”Œë¦½", type:"eff_buff", cost:2, val:5, life:2, color:"#00ccff", desc:"ë§¤í„´ ê³µê²©ë³´ì • +5."}),
            ...Array(2).fill({name:"ìŠ¤ë˜ì‰¬", type:"inst_thrash", cost:4, val:12, color:"#ffffff", desc:"íŒ¨ ëª¨ë‘ ë²„ë¦¼. ì¥ë‹¹ 12 ë°ë¯¸ì§€."}),
            ...Array(3).fill({name:"íŒœë®¤íŠ¸", type:"inst_buff", cost:1, val:5, color:"#aaaaaa", desc:"ì´ë²ˆ í„´ ê³µê²©ë ¥ +5."}),
            ...Array(3).fill({name:"ì†Œí˜•ê±´ì „ì§€", type:"inst_energy", cost:0, val:1, color:"#ffff00", desc:"ì—ë„ˆì§€ +1"}),
            ...Array(3).fill({name:"ì˜¤ë²„íˆíŠ¸", type:"inst_eng_harm", cost:0, val:2, self:5, color:"#ffaa00", desc:"ì—ë„ˆì§€ +2 / ë‚˜ì—ê²Œ 5ë€."}),
            ...Array(2).fill({name:"ìŠ¬ë¼ì´ë”©", type:"inst_draw", cost:1, val:1, color:"#aaaaaa", desc:"1ì¥ ë“œë¡œìš°."})
        ]
    };

    let game = { mode: 'pvp', aiId: null };
    let animating = false;
    let tempDice = { d6:0, d10:0, d20:0 }; // íŠœë„ˆ ì¡°ì‘ìš© ì„ì‹œ ì €ì¥
    let activeNudges = 0; // ë‚¨ì€ ì¡°ì‘ íšŸìˆ˜

    // --- ì‹œê° íš¨ê³¼ ---
    function showFloatingText(targetId, text, type) {
        const area = document.getElementById(`${targetId}-area`);
        const el = document.createElement('div');
        el.className = `float-text ${type}`;
        el.innerText = text;
        el.style.left = '50%'; el.style.top = '50%'; el.style.transform = 'translate(-50%, -50%)';
        area.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    function showAttackWave(attackerId) {
        const gameContainer = document.getElementById('game-container');
        const wave = document.createElement('div');
        wave.className = 'sound-wave';
        wave.style.left = '50%';
        if(attackerId === 'p1') wave.style.animation = 'ripple-up 0.6s ease-out forwards';
        else wave.style.animation = 'ripple-down 0.6s ease-out forwards';
        gameContainer.appendChild(wave);
        setTimeout(() => wave.remove(), 600);
    }

    // --- ê²Œì„ ë¡œì§ ---
    function selectMode(mode) {
        game.mode = mode;
        document.getElementById('mode-pvp').classList.remove('selected');
        document.getElementById('mode-ai').classList.remove('selected');
        document.getElementById(`mode-${mode}`).classList.add('selected');
        document.getElementById('deck-setup').classList.add('visible');
        document.getElementById('btn-start-game').classList.add('visible');
        if(mode === 'ai') {
            document.getElementById('p1-label').innerText = "MY DECK";
            document.getElementById('p2-label').innerText = "AI DECK";
        } else {
            document.getElementById('p1-label').innerText = "PLAYER 1";
            document.getElementById('p2-label').innerText = "PLAYER 2";
        }
    }

    function startRoulette() {
        document.getElementById('start-screen').style.display = 'none';
        const overlay = document.getElementById('roulette-overlay');
        const text = document.getElementById('roulette-text');
        overlay.style.display = 'flex';
        let count = 0, speed = 50, currentP = 1;
        const interval = setInterval(() => {
            currentP = currentP === 1 ? 2 : 1;
            text.innerText = game.mode === 'ai' ? (currentP===1 ? "YOU" : "AI") : `PLAYER ${currentP}`;
            text.className = `roulette-box roulette-p${currentP}`;
            count++;
            if (count > 20) speed += 20; 
            if (count > 30) {
                clearInterval(interval);
                finalizeStart(currentP === 1 ? 'p1' : 'p2');
            }
        }, 100);
    }

    function finalizeStart(firstPlayer) {
        setTimeout(() => {
            document.getElementById('roulette-overlay').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            startGame(firstPlayer);
        }, 1000);
    }

    function startGame(activePid) {
        const p1Type = document.getElementById('p1-deck-select').value;
        const p2Type = document.getElementById('p2-deck-select').value;
        game.p1 = new Player('p1', p1Type);
        game.p2 = new Player('p2', p2Type);
        game.turn = 1;
        game.active = activePid;
        
        if (game.mode === 'ai') {
            game.aiId = 'p2';
            document.getElementById('p1-name-display').innerText = "YOU"; 
            document.getElementById('p2-name-display').innerText = "AI";
        }
        document.getElementById('p1-deck-name').innerText = p1Type.toUpperCase();
        document.getElementById('p2-deck-name').innerText = p2Type.toUpperCase();
        log("=== BATTLE START ===");
        
        const second = activePid === 'p1' ? 'p2' : 'p1';
        setTimeout(() => {
            log(`ğŸ€ í›„ê³µ ëŸ­í‚¤ë°°í„°ë¦¬ ì²´í¬...`);
            if(Math.random() < 0.5) {
                game[second].energy += 1;
                log("ğŸ‰ ì„±ê³µ! ì—ë„ˆì§€ +1");
                showFloatingText(second, "+1 ENERGY", "heal-pos");
            } else log("ğŸ’¨ ì‹¤íŒ¨.");
            game.p1.draw(5); game.p2.draw(5);
            startTurn();
        }, 800);
    }

    class Player {
        constructor(id, type) {
            this.id = id; this.type = type; this.hp = 150; this.energy = 0;
            this.deck = JSON.parse(JSON.stringify(DECKS[type])).sort(()=>Math.random()-0.5);
            this.deck.forEach(c => c.uid = Math.random());
            this.hand = []; this.field = []; this.trash = [];
            this.turnStats = { atk:0, def:0, gate:0 };
            this.tunerRolled = false;
        }
        draw(n) {
            for(let i=0; i<n; i++) {
                if(this.hand.length>=6) break;
                if(!this.deck.length) {
                    if(!this.trash.length) break;
                    this.deck = this.trash.sort(()=>Math.random()-0.5); this.trash=[];
                    log("ğŸ”„ ë± ë¦¬í•„");
                }
                this.hand.push(this.deck.pop());
            }
        }
    }

    function startTurn() {
        const p = game[game.active];
        p.energy = Math.min(10, p.energy+1);
        p.draw(1);
        p.tunerRolled = false;
        p.turnStats = { atk:0, def:0, gate:0 };
        
        document.getElementById(`${game.active}-d6`).innerText = "-";
        document.getElementById(`${game.active}-d10`).innerText = "-";
        document.getElementById(`${game.active}-d20`).innerText = "-";
        
        // ë„ˆì§€ UI ìˆ¨ê¸°ê¸°
        document.getElementById('p1-mod-ui').style.visibility = 'hidden';
        document.getElementById('p2-mod-ui').style.visibility = 'hidden';
        document.getElementById('p1-mod-confirm').style.display = 'none';
        document.getElementById('p2-mod-confirm').style.display = 'none';

        updateGuide(p.type);
        log(`\n=== TURN ${game.turn} : ${game.active.toUpperCase()} ===`);
        
        let heal = 0;
        p.field.forEach(item => {
            const c = item.card;
            if(c.type === 'eff_def') p.turnStats.def += c.val;
            if(c.type === 'eff_gate') p.turnStats.gate = Math.max(p.turnStats.gate, c.val);
            if(c.type === 'eff_buff') p.turnStats.atk += c.val;
            if(c.type === 'eff_heal') heal += c.val;
        });
        if(heal > 0) {
            p.hp = Math.min(150, p.hp + heal);
            log(`ğŸ’š í•„ë“œ íš¨ê³¼: ì²´ë ¥ +${heal}`);
            showFloatingText(game.active, `+${heal}`, "heal-pos");
        }
        render();
        if(game.mode === 'ai' && game.active === game.aiId) setTimeout(aiAction, 1000);
    }

    function aiAction() {
        const ai = game.p2;
        const handIndices = ai.hand.map((_, i) => i);
        for (let i of handIndices) {
            const c = ai.hand[i];
            if (!c) continue; 
            if(c.type.startsWith('eff_') && ai.field.length >= 3) continue;
            if (c.cost <= ai.energy) {
                actions.playCard(game.active, i);
                setTimeout(aiAction, 800); 
                return; 
            }
        }
        if (!ai.tunerRolled) {
            actions.rollTuner(game.active);
            setTimeout(() => { 
                // AIëŠ” ë„ˆì§€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ìµœì í™”? (ë‹¨ìˆœí™”: ì¼ë‹¨ íŠœë„ˆ í›„ ë°”ë¡œ ê³µê²©)
                if(activeNudges > 0) actions.confirmTuner(game.active); // ê·¸ëƒ¥ í™•ì¸
                setTimeout(() => actions.attack(game.active), 500); 
            }, 1500); 
        }
    }

    const actions = {
        rollTuner: (pid) => {
            if(game.active !== pid || animating) return;
            const p = game[pid];
            if(p.tunerRolled) return;

            animating = true;
            document.getElementById(`${pid}-btn-tuner`).disabled = true;
            p.tunerRolled = true; 
            render(); 

            let count=0;
            const intv = setInterval(()=>{
                document.getElementById(`${pid}-d6`).innerText = r(6);
                document.getElementById(`${pid}-d10`).innerText = r(10);
                document.getElementById(`${pid}-d20`).innerText = r(20);
                count++;
                if(count>10) { clearInterval(intv); startNudgePhase(pid); }
            }, 50);
        },

        modTuner: (pid, diceIdx) => {
            if(activeNudges <= 0) return alert("ë³´ì • íšŸìˆ˜ ì†Œì§„!");
            const keys = ['d6','d10','d20'];
            const key = keys[diceIdx];
            
            if(tempDice[key] > 1) {
                tempDice[key]--;
                activeNudges--;
                document.getElementById(`${pid}-${key}`).innerText = tempDice[key];
                log(`ğŸ”§ [ë„ˆì§€] ${key.toUpperCase()} -1 ë³´ì • (ë‚¨ì€ íšŸìˆ˜: ${activeNudges})`);
                if(activeNudges <= 0) document.getElementById(`${pid}-mod-ui`).style.visibility = 'hidden';
            }
        },

        confirmTuner: (pid) => {
            document.getElementById(`${pid}-mod-ui`).style.visibility = 'hidden';
            document.getElementById(`${pid}-mod-confirm`).style.display = 'none';
            finalizeTuner(pid);
        },
        
        attack: (pid) => {
            if(game.active !== pid || animating) return;
            const p = game[pid];
            const opp = game[pid==='p1'?'p2':'p1'];
            const oppId = pid==='p1'?'p2':'p1';
            
            showAttackWave(pid);

            let totalDmg = p.turnStats.atk; 
            let pierceDmg = 0;
            let selfDmg = 0;
            
            p.field.forEach(item => {
                const c = item.card;
                if(c.type === 'eff_delay') {
                    if(item.life === 1) { log(`ğŸ’¥ í‚µìº„ í­ë°œ!`); totalDmg += c.val; }
                }
                else if(c.type === 'eff_atk') totalDmg += c.val;
                else if(c.type === 'eff_self') { totalDmg += c.val; selfDmg += c.self; }
                else if(c.type === 'eff_pierce') pierceDmg += c.val;
                else if(c.type === 'eff_risky') {
                    if(Math.random() < 0.3) { log(`âš¡ ë¦¬ìŠ¤í‚¤ ëŒ€ë°•!`); totalDmg += c.val; }
                    else totalDmg += c.fail;
                }
            });
            
            if(selfDmg > 0) { 
                p.hp -= selfDmg; 
                log(`ğŸ©¸ ì´í™í„° ê³¼ë¶€í•˜ -${selfDmg}`);
                showFloatingText(pid, `-${selfDmg}`, "dmg-neg");
            }
            
            let oppDef = 0;
            let oppGate = 0;
            opp.field.forEach(item => {
                if(item.card.type === 'eff_def') oppDef += item.card.val;
                if(item.card.type === 'eff_gate') oppGate = Math.max(oppGate, item.card.val);
            });
            
            if(pierceDmg > 0) {
                if(pierceDmg > oppGate) { 
                    opp.hp -= pierceDmg; 
                    log(`ğŸ—¡ï¸ ê´€í†µ í”¼í•´ ${pierceDmg}`); 
                    showFloatingText(oppId, `+${pierceDmg}`, "dmg-pos");
                } else log(`ğŸ›¡ï¸ ë…¸ì´ì¦ˆê²Œì´íŠ¸ê°€ ê´€í†µ ë§‰ìŒ`);
            }
            
            let final = Math.max(0, totalDmg - oppDef);
            if(final <= oppGate && final > 0) { final = 0; log(`ğŸ›¡ï¸ ë…¸ì´ì¦ˆê²Œì´íŠ¸ ë°©ì–´!`); }
            
            if(final > 0) { 
                opp.hp -= final; 
                log(`âš”ï¸ ì¼ë°˜ í”¼í•´ ${final}`); 
                showFloatingText(oppId, `+${final}`, "dmg-pos");
            } else if(totalDmg > 0) log(`ğŸ›¡ï¸ ë°©ì–´ë¨`);
            
            if(p.hp<=0) gameOver(pid==='p1'?'p2':'p1');
            else if(opp.hp<=0) gameOver(pid);
            else setTimeout(() => endTurn(pid), 600);
        },
        
        playCard: (pid, idx) => {
            if(game.active !== pid || animating) return;
            const p = game[pid];
            if(p.tunerRolled) return alert("íŠœë„ˆë¥¼ êµ´ë¦° í›„ì—ëŠ” ì¹´ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");

            const c = p.hand[idx];
            if(p.energy < c.cost) {
                if(game.mode!=='ai' || game.active!=='p2') alert("ì—ë„ˆì§€ ë¶€ì¡±");
                return;
            }
            p.energy -= c.cost;
            p.hand.splice(idx, 1);
            hideTooltip();
            log(`â–¶ [${c.name}] ì‚¬ìš©`);
            
            if(c.type.startsWith('inst_')) {
                if(c.type==='inst_heal') {
                    p.hp = Math.min(150, p.hp+c.val);
                    showFloatingText(pid, `+${c.val}`, "heal-pos");
                }
                if(c.type==='inst_energy') p.energy += c.val;
                if(c.type==='inst_eng_harm') { 
                    p.energy+=c.val; p.hp-=c.self; 
                    showFloatingText(pid, `-${c.self}`, "dmg-neg");
                }
                if(c.type==='inst_draw') p.draw(c.val);
                if(c.type==='inst_buff') p.turnStats.atk += c.val;
                if(c.type==='inst_thrash') {
                    const dmg = p.hand.length * c.val;
                    p.hand = [];
                    p.turnStats.atk += dmg;
                    log(`ğŸ”¥ ìŠ¤ë˜ì‰¬! +${dmg} ë°ë¯¸ì§€ ì¶”ê°€`);
                }
                p.trash.push(c);
            } 
            else {
                if(p.field.length >= 3) { p.energy+=c.cost; p.hand.push(c); return alert("í•„ë“œ ê½‰ ì°¸"); }
                if(c.type==='eff_def') p.turnStats.def += c.val;
                if(c.type==='eff_gate') p.turnStats.gate = Math.max(p.turnStats.gate, c.val);
                if(c.type==='eff_buff') p.turnStats.atk += c.val;
                if(c.type==='eff_heal') {
                    p.hp = Math.min(150, p.hp+c.val);
                    showFloatingText(pid, `+${c.val}`, "heal-pos");
                }
                p.field.push({ card: c, life: 2 });
            }
            render();
        }
    };

    function startNudgePhase(pid) {
        const p = game[pid];
        tempDice = { d6: r(6), d10: r(10), d20: r(20) };
        document.getElementById(`${pid}-d6`).innerText = tempDice.d6;
        document.getElementById(`${pid}-d10`).innerText = tempDice.d10;
        document.getElementById(`${pid}-d20`).innerText = tempDice.d20;

        // ë„ˆì§€(nudge) ì²´í¬
        activeNudges = 0;
        p.field.forEach(item => { if(item.card.type === 'eff_nudge') activeNudges++; });

        if(activeNudges > 0) {
            log(`ğŸ”§ ë„ˆì§€ ë°œë™ ê°€ëŠ¥! (${activeNudges}íšŒ)`);
            if(game.mode === 'ai' && pid === 'p2') {
                // AIëŠ” ì¼ë‹¨ ìŠ¤í‚µ (í™•ì¸ë§Œ)
                setTimeout(() => actions.confirmTuner(pid), 500);
            } else {
                document.getElementById(`${pid}-mod-ui`).style.visibility = 'visible';
                document.getElementById(`${pid}-mod-confirm`).style.display = 'inline-block';
            }
        } else {
            finalizeTuner(pid);
        }
    }

    function finalizeTuner(pid) {
        const p = game[pid];
        let bonus = 0; let self = 0;
        const d6 = tempDice.d6; const d10 = tempDice.d10; const d20 = tempDice.d20;

        if(p.type === 'alt') {
            if(d6>=4) bonus+=1; if(d10>=6) bonus+=2; if(d20>=15) bonus+=5;
        } else {
            if(d6<=3) { self+=3; document.getElementById(`${pid}-d6`).style.color='red'; }
            else bonus+=3;
            if(d10>=7) bonus+=4; if(d20>=18) bonus+=10;
        }
        
        p.turnStats.atk += bonus;
        if(self>0) { 
            p.hp -= self; 
            log(`ğŸ©¸ íŠœë„ˆ ìí•´ -${self}`); 
            showFloatingText(pid, `-${self}`, "dmg-neg");
        }
        
        log(`ğŸ² íŠœë„ˆ í™•ì •: ê³µê²©ë ¥ +${bonus}`);
        if(p.hp<=0) gameOver(pid==='p1'?'p2':'p1');
        
        animating = false;
        render();
    }

    function endTurn(pid) {
        const p = game[pid];
        p.field = p.field.filter(item => {
            item.life--;
            if(item.life <= 0) { p.trash.push(item.card); return false; }
            return true;
        });
        game.turn++;
        game.active = pid==='p1'?'p2':'p1';
        startTurn();
    }

    function gameOver(winnerId) {
        const name = (game.mode==='ai' && winnerId==='p1') ? "YOU" : (game.mode==='ai' && winnerId==='p2') ? "AI" : (winnerId==='p1' ? "PLAYER 1" : "PLAYER 2");
        document.getElementById('winner-text').innerText = `${name} WINS!`;
        document.getElementById('gameover-overlay').style.display = 'flex';
    }

    function updateGuide(type) {
        const el = document.getElementById('guide-content');
        if(type === 'alt') el.innerHTML = `<div>1d6(4â†‘):+1</div><div>1d10(6â†‘):+2</div><div>1d20(15â†‘):+5</div>`;
        else el.innerHTML = `<div style="color:red">1d6(3â†“):ìí•´3</div><div>1d6(4â†‘):+3</div><div>1d10(7â†‘):+4</div><div>1d20(18â†‘):+10</div>`;
    }

    function render() {
        renderP('p1'); renderP('p2');
        document.getElementById('p1-area').className = `player-area ${game.active==='p1'?'active-turn':'inactive-turn'}`;
        document.getElementById('p2-area').className = `player-area ${game.active==='p2'?'active-turn':'inactive-turn'}`;
    }

    function renderP(pid) {
        const p = game[pid];
        document.getElementById(`${pid}-hp`).innerText = p.hp;
        document.getElementById(`${pid}-energy`).innerText = p.energy;
        const isMyTurn = game.active === pid;
        const isHumanControl = (game.mode === 'pvp') || (game.mode === 'ai' && pid === 'p1');
        document.getElementById(`${pid}-btn-tuner`).disabled = !isMyTurn || p.tunerRolled || !isHumanControl;
        document.getElementById(`${pid}-btn-attack`).disabled = !isMyTurn || !p.tunerRolled || !isHumanControl;
        
        const h = document.getElementById(`${pid}-hand`); h.innerHTML = '';
        p.hand.forEach((c, i) => {
            const el = document.createElement('div'); el.className = 'card';
            if(p.tunerRolled) el.classList.add('locked');
            el.style.borderColor = c.color;
            el.innerHTML = `<div class="card-name">${c.name}</div><div style="font-size:0.6em;text-align:center">${c.type.split('_')[1]||'skill'}</div><div class="card-cost">âš¡${c.cost}</div>`;
            el.onmouseenter = e => showTooltip(e, c); el.onmousemove = moveTooltip; el.onmouseleave = hideTooltip;
            if(isMyTurn && !p.tunerRolled && isHumanControl) { el.onclick = () => actions.playCard(pid, i); }
            h.appendChild(el);
        });
        
        const f = document.getElementById(`${pid}-field`); f.innerHTML = '';
        p.field.forEach(item => {
            const el = document.createElement('div'); el.className = 'field-card'; el.style.borderColor = item.card.color;
            el.innerHTML = `<div style="font-size:0.7em;color:#fff">${item.card.name}</div><div class="life-indicator">${"â—".repeat(item.life)}</div>`;
            f.appendChild(el);
        });
    }

    function r(n) { return Math.ceil(Math.random()*n); }
    const tooltip = document.getElementById('tooltip');
    function showTooltip(e, c) {
        document.getElementById('tt-title').innerText = c.name;
        document.getElementById('tt-desc').innerText = c.desc;
        tooltip.style.display = 'block'; moveTooltip(e);
    }
    function moveTooltip(e) {
        tooltip.style.left = Math.min(e.clientX+15, window.innerWidth-230)+'px';
        tooltip.style.top = Math.min(e.clientY+15, window.innerHeight-100)+'px';
    }
    function hideTooltip() { tooltip.style.display='none'; }
    function log(msg) { 
        const l = document.getElementById('game-log'); 
        const d = document.createElement('div'); d.innerText = msg; l.prepend(d); 
    }
</script>
</body>
</html>
